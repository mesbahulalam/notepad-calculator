<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad Calculator Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Wrapper Styles --- */
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item.active {
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        .dark .sidebar-item.active {
            background-color: #374151; /* dark:bg-gray-700 */
        }
        
        /* --- Custom styles for Calculator --- */
        #editor:focus {
            outline: none;
        }
        #editor::placeholder {
            color: inherit;
            font-family: serif;
            text-align: left;
            font-style: italic;
            opacity: .2;
            white-space: normal;
        }
        #backdrop > div {
            overflow: hidden;
            white-space: pre;
        }
        #backdrop > div:empty::before {
            content: ' ';
        }
        #backdrop .fail {
            color: crimson;
        }
        #backdrop .fail .marker {
            background-color: rgba(220, 20, 60, 0.12);
            text-decoration: underline;
            text-decoration-style: wavy;
            text-decoration-color: crimson;
        }
        #backdrop .success {
            opacity: .3;
            font-style: italic;
        }
        .icon {
            width: 1.1em;
            height: 1.1em;
            display: inline-block;
            stroke-width: 0;
            stroke: currentColor;
            fill: currentColor;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-800">
    <div class="flex h-screen bg-gray-50 dark:bg-gray-800">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-72 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 fixed inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out z-30 flex flex-col">
            <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 py-3 px-4 z-10 border-b border-gray-300 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Saved Notes</h2>
                <button id="new-note-btn" title="Create New Note" class="p-2 rounded-md transition duration-200 hover:bg-gray-300 dark:hover:bg-gray-700">
                    <i data-feather="plus" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto">
                <ul id="note-list" class="p-2 space-y-1">
                    <!-- Saved notes will be injected here by JS -->
                </ul>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Navbar -->
            <header class="bg-white dark:bg-gray-900 z-10 border-b border-gray-300 dark:border-gray-700">
                <div class="container mx-auto px-6 flex items-center justify-between h-16">
                    <button id="menu-toggle" class="text-gray-800 dark:text-gray-200 lg:hidden">
                        <i data-feather="menu" class="w-6 h-6"></i>
                    </button>
                    <h1 id="navbar-title" class="text-xl font-bold text-gray-800 dark:text-gray-200 lg:text-left flex-grow text-center">Notepad Calculator</h1>
                    <div class="relative flex items-center">
                        <span id="save-status" class="text-sm text-gray-500 mr-4 transition-opacity duration-300 opacity-0"></span>
                    </div>
                </div>
            </header>

            <!-- Calculator Content -->
            <main class="flex-1 overflow-y-auto bg-white dark:bg-gray-800 p-0 flex flex-col">
                <div id="app" class="w-full h-full flex flex-col">
                    <section id="canvas" class="relative flex-grow flex overflow-x-auto p-6">
                        <div id="canvas-anchor" class="relative z-0 w-full">
                            <textarea id="editor" rows="1" spellcheck="false" placeholder="Type your math problems here...&#10;&#10;Examples:&#10;rate = 73&#10;subtotal&#10;&#10;12 nights&#10;rate * nights =&#10;subtotal&#10;&#10;total&#10;&#10;price = 100&#10;tax = 20&#10;subtotalvars&#10;totalvars =" 
                            class="block bg-transparent p-0 whitespace-pre border-0 resize-none overflow-hidden text-current font-mono text-base leading-relaxed w-full h-full box-border"></textarea>
                            <div id="backdrop" class="absolute top-0 left-0 pointer-events-none z-[-2] font-mono text-base leading-relaxed w-full h-full box-border">&nbsp;</div>
                        </div>
                    </section>
                    <section id="app-toolbar" class="text-sm py-2 px-4 text-right border-t border-gray-200 bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
                        <div class="flex flex-row items-center gap-2 justify-end">
                            <img src="https://views-counter.vercel.app/badge?pageId=https%3A%2F%2Fmesbahulalam%2Egithub%2Eio%2Fnotepad-calculator&leftColor=000000&rightColor=0adb3f&type=total&label=Page%20Views&style=none" alt="Views Counter">
                            <a id="copyBtn" title="Copy all text to clipboard" href="#" class="no-underline text-gray-700 dark:text-gray-300 inline-flex py-1 px-2 rounded transition-colors duration-200 hover:bg-gray-200 dark:hover:bg-gray-700">
                                <svg class="icon"><use xlink:href="#icon-clipboard"></use></svg>
                                <span>Copy</span>
                            </a>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-20 hidden lg:hidden"></div>
    </div>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Hidden SVG definitions for calculator icons -->
    <svg style="display:none;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <symbol id="icon-clipboard" viewBox="0 0 32 32">
                <title>clipboard</title>
                <path d="M29 4h-9c0-2.209-1.791-4-4-4s-4 1.791-4 4h-9c-0.552 0-1 0.448-1 1v26c0 0.552 0.448 1 1 1h26c0.552 0 1-0.448 1-1v-26c0-0.552-0.448-1-1-1zM16 2c1.105 0 2 0.895 2 2s-0.895 2-2 2c-1.105 0-2-0.895-2-2s0.895-2 2-2zM28 30h-24v-24h4v3c0 0.552 0.448 1 1 1h14c0.552 0 1-0.448 1-1v-3h4v24z"></path>
                <path d="M14 26.828l-6.414-7.414 1.828-1.828 4.586 3.586 8.586-7.586 1.829 1.828z"></path>
            </symbol>
        </defs>
    </svg>

    <!-- Wrapper, History, and Saving Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const newNoteBtn = document.getElementById('new-note-btn');
            const noteList = document.getElementById('note-list');
            const editor = document.getElementById('editor');
            const saveStatus = document.getElementById('save-status');

            // --- State ---
            let savedNotes = [];
            let activeNoteId = null;
            let saveTimeout;

            // --- Debounce function for auto-saving ---
            const debounce = (func, delay) => {
                return function(...args) {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => func.apply(this, args), delay);
                };
            };
            
            // --- Date Formatter ---
            const formatDate = (date) => {
                const d = new Date(date);
                const pad = (num) => num.toString().padStart(2, '0');
                return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear().toString().substr(-2)} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            };
            
            // --- Core Functions ---
            const loadNotesFromStorage = () => {
                const notes = localStorage.getItem('notepadCalculatorNotes');
                savedNotes = notes ? JSON.parse(notes) : [];
            };

            const saveNotesToStorage = () => {
                localStorage.setItem('notepadCalculatorNotes', JSON.stringify(savedNotes));
                saveStatus.textContent = 'Saved!';
                saveStatus.classList.remove('opacity-0');
                setTimeout(() => saveStatus.classList.add('opacity-0'), 2000);
            };

            const debouncedSave = debounce(saveNotesToStorage, 1500);

            const renderNoteList = () => {
                noteList.innerHTML = '';
                if (savedNotes.length === 0) {
                    noteList.innerHTML = `<li class="px-4 py-2 text-sm text-gray-500 text-center">No notes yet.</li>`;
                    return;
                }
                
                // Sort notes by ID (timestamp) descending
                savedNotes.sort((a, b) => b.id - a.id);
                
                savedNotes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = `sidebar-item group flex items-center justify-between py-2 px-4 rounded transition duration-200 hover:bg-gray-300 dark:hover:bg-gray-700 text-sm cursor-pointer`;
                    li.dataset.id = note.id;
                    if (note.id === activeNoteId) {
                        li.classList.add('active');
                    }
                    
                    li.innerHTML = `
                        <span class="truncate flex-grow" data-action="load">${note.name}</span>
                        <div class="flex items-center ml-2">
                             <button data-action="rename" class="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-gray-400 dark:hover:bg-gray-600 focus:opacity-100" title="Rename Note">
                                <i data-feather="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button data-action="delete" class="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-gray-400 dark:hover:bg-gray-600 focus:opacity-100" title="Delete Note">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    noteList.appendChild(li);
                });
                feather.replace();
            };

            const loadNote = (id) => {
                const note = savedNotes.find(n => n.id === id);
                if (note) {
                    activeNoteId = id;
                    editor.value = note.content;
                    if (window.calculatorApp) {
                        window.calculatorApp.trigger(); // Trigger calculator refresh
                    }
                    renderNoteList();
                }
            };
            
            const createNewNote = () => {
                const now = Date.now();
                const newNote = {
                    id: now,
                    name: formatDate(now),
                    content: ''
                };
                savedNotes.push(newNote);
                saveNotesToStorage();
                loadNote(newNote.id);
                 if (window.innerWidth < 1024) { toggleSidebar(); }
            };

            const deleteNote = (id) => {
                savedNotes = savedNotes.filter(n => n.id !== id);
                saveNotesToStorage();
                
                if (activeNoteId === id) {
                    if (savedNotes.length > 0) {
                        // Sort to ensure we load the most recent note
                        loadNote(savedNotes.sort((a, b) => b.id - a.id)[0].id);
                    } else {
                        // History is empty, clear the editor state
                        activeNoteId = null;
                        editor.value = '';
                        if (window.calculatorApp) {
                            window.calculatorApp.trigger(); // Trigger calculator refresh
                        }
                        renderNoteList(); // Re-render to show empty state
                    }
                } else {
                   renderNoteList();
                }
            };

            const renameNote = (id, targetSpan) => {
                const originalName = targetSpan.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalName;
                input.className = 'bg-white dark:bg-gray-800 text-sm p-1 rounded w-full';
                
                targetSpan.replaceWith(input);
                input.focus();
                input.select();

                const finishEditing = () => {
                    const newName = input.value.trim() || originalName;
                    const note = savedNotes.find(n => n.id === id);
                    if (note) {
                        note.name = newName;
                        saveNotesToStorage();
                    }
                    input.replaceWith(targetSpan);
                    targetSpan.textContent = newName; // update span immediately
                };

                input.addEventListener('blur', finishEditing);
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') input.blur();
                    if (e.key === 'Escape') {
                        input.value = originalName;
                        input.blur();
                    }
                });
            };

            // --- Sidebar and Dropdown Logic ---
            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            };
            
            // --- Event Listeners ---
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSidebar();
            });
            sidebarOverlay.addEventListener('click', toggleSidebar);
            newNoteBtn.addEventListener('click', createNewNote);

            noteList.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                const li = target.closest('.sidebar-item');
                const id = Number(li.dataset.id);

                if (action === 'load') {
                    loadNote(id);
                    if (window.innerWidth < 1024) { toggleSidebar(); }
                }
                if (action === 'delete') {
                    // Use a custom modal or remove confirm for better UX in production
                    if (confirm('Are you sure you want to delete this note?')) {
                        deleteNote(id);
                    }
                }
                if (action === 'rename') {
                    const nameSpan = li.querySelector('[data-action="load"]');
                    renameNote(id, nameSpan);
                }
            });

            editor.addEventListener('input', () => {
                // If there's no active note, this is the first input in a new session.
                // Create a new note in memory.
                if (!activeNoteId) {
                    const now = Date.now();
                    const newNote = {
                        id: now,
                        name: formatDate(now),
                        content: '' // Content will be updated right after this block
                    };
                    savedNotes.push(newNote);
                    activeNoteId = newNote.id;
                    renderNoteList(); // This will highlight the new note in the sidebar
                }
                
                // Now that we're sure there's an active note (either existing or just created),
                // find it and update its content.
                const note = savedNotes.find(n => n.id === activeNoteId);
                if (note) {
                    note.content = editor.value;
                    saveStatus.textContent = 'Saving...';
                    saveStatus.classList.remove('opacity-0');
                    debouncedSave();
                }
            });
            
            // --- Initialisation ---
            const init = () => {
                loadNotesFromStorage();
                if (savedNotes.length === 0) {
                    // Don't create a note, just render the empty state
                    activeNoteId = null;
                    editor.value = '';
                    renderNoteList();
                    if (window.calculatorApp) {
                        window.calculatorApp.trigger();
                    }
                } else {
                    // Load the most recent note on startup
                    loadNote(savedNotes.sort((a,b)=>b.id-a.id)[0].id);
                }
                feather.replace();
            };

            init();
        });
    </script>
    
    <!-- Core application logic -->
    <script>
        Settings = { decimalPoint: '.' };
        Util = {};
        Util.esc = function(s) { return s.replace(/[&<>'"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); };
        Dom = {};
        Dom.appendSibling = function(elm, sibling) {
            if (elm.nextSibling) { elm.parentNode.insertBefore(sibling, elm.nextSibling); } 
            else { elm.parentNode.appendChild(sibling); }
        };
    </script>
    <script>function CalcNumber(n,i,o,s){var u,c,a,f=function(t,r){var e=Math.pow(10,Math.abs(r));return r<0?t/=e:r>0&&(t*=e),t};1===(u=String(n).split(/\D/g)).length?(c=n,a=""):(a=u.pop(),c=u.join("")),this.type=CalcNumber.NUMBER,this.shift=0,this.suffix=o,this.precision=a.length,i?(this.type=CalcNumber.PERCENT,this.suffix="%",this.shift=-2,this.precision+=2):s&&(this.type=CalcNumber.SI_NUMBER,this.shift=r[s.toUpperCase()]),this.big=Big(f(Number(c+"."+a),this.shift)),this.valueOf=function(){return Number(this.big.valueOf())},this.toString=function(){return this.big.toString()},this.format=function(){var n,i,o="",s=this.valueOf(),u=this.shift;return this.type===CalcNumber.SI_NUMBER&&(o=e(s),u=r[o]),s=f(s,-u),i=f(s,this.precision),i=Math.floor(i),i=f(i,-this.precision),i=i.toString(),n=s.toString().substr(i.length),s=i,n&&(s+=n.substr(0,6),n.length>5&&(s+="…")),s.toString()+o+this.suffix},this.clone=function(){return Object.assign(Object.create(this),this)},this.opType=function(){return this.type===CalcNumber.SI_NUMBER?CalcNumber.NUMBER:this.type},this.sync=function(t,r){var e=this.clone();return e.big=t,e.precision=Math.max(e.precision,r.precision),e},this["n + n"]=function(t){return this.sync(this.big.plus(t.big),t)},this["n - n"]=function(t){return this.sync(this.big.minus(t.big),t)},this["n * n"]=function(t){return this.sync(this.big.times(t.big),t)},this["n / n"]=function(t){return this.sync(this.big.div(t.big),t)},this["n ^ n"]=function(t){return this.sync(this.big.pow(t.big),t)},this["n + p"]=function(t){return this["n + n"](this["n * n"](t),t)},this["n - p"]=function(t){return this["n - n"](this["n * n"](t),t)},this["n * p"]=this["n * n"],this["n / p"]=this["n / n"],this["p of n"]=function(t){return t["n * n"](this)}}!function(t){"use strict";function r(t,r,e,n){var i=t.c,o=t.e+r+1;if(o<i.length){if(1===e)n=5<=i[o];else if(2===e)n=5<i[o]||5==i[o]&&(n||o<0||i[o+1]!==l||1&i[o-1]);else if(3===e)n=n||!!i[0];else if(n=!1,0!==e)throw Error(c);if(o<1)i.length=1,i[0]=n?(t.e=-r,1):t.e=0;else{if(i.length=o--,n)for(;9<++i[o];)i[o]=0,o--||(++t.e,i.unshift(1));for(o=i.length;!i[--o];)i.pop()}}else if(e<0||3<e||e!==~~e)throw Error(c);return t}function e(t,e,n,o){var c,a,f=t.constructor,h=!t.c[0];if(n!==l){if(n!==~~n||n<(3==e)||i<n)throw Error(3==e?s+"precision":u);for(n=o-(t=new f(t)).e,t.c.length>++o&&r(t,n,f.RM),2==e&&(o=t.e+n+1);t.c.length<o;)t.c.push(0)}if(c=t.e,n=(a=t.c.join("")).length,2!=e&&(1==e||3==e&&o<=c||c<=f.NE||c>=f.PE))a=a.charAt(0)+(1<n?"."+a.slice(1):"")+(c<0?"e":"e+")+c;else if(c<0){for(;++c;)a="0"+a;a="0."+a}else if(0<c)if(++c>n)for(c-=n;c--;)a+="0";else c<n&&(a=a.slice(0,c)+"."+a.slice(c));else 1<n&&(a=a.charAt(0)+"."+a.slice(1));return t.s<0&&(!h||4==e)?"-"+a:a}var n,i=1e6,o="[big.js] ",s=o+"Invalid ",u=s+"decimal places",c=s+"rounding mode",a=o+"Division by zero",f={},l=void 0,h=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i;f.abs=function(){var t=new this.constructor(this);return t.s=1,t},f.cmp=function(t){var r,e=this,n=e.c,i=(t=new e.constructor(t)).c,o=e.s,s=t.s,u=e.e,c=t.e;if(!n[0]||!i[0])return n[0]?o:i[0]?-s:0;if(o!=s)return o;if(r=o<0,u!=c)return c<u^r?1:-1;for(s=(u=n.length)<(c=i.length)?u:c,o=-1;++o<s;)if(n[o]!=i[o])return n[o]>i[o]^r?1:-1;return u==c?0:c<u^r?1:-1},f.div=function(t){var e=this,n=e.constructor,o=e.c,s=(t=new n(t)).c,c=e.s==t.s?1:-1,f=n.DP;if(f!==~~f||f<0||i<f)throw Error(u);if(!s[0])throw Error(a);if(!o[0])return new n(0*c);var h,p,g,d,v,A=s.slice(),m=h=s.length,b=o.length,y=o.slice(0,h),w=y.length,x=t,E=x.c=[],C=0,F=f+(x.e=e.e-t.e)+1;for(x.s=c,c=F<0?0:F,A.unshift(0);w++<h;)y.push(0);do{for(g=0;g<10;g++){if(h!=(w=y.length))d=w<h?1:-1;else for(v=-1,d=0;++v<h;)if(s[v]!=y[v]){d=s[v]>y[v]?1:-1;break}if(!(d<0))break;for(p=w==h?s:A;w;){if(y[--w]<p[w]){for(v=w;v&&!y[--v];)y[v]=9;--y[v],y[w]+=10}y[w]-=p[w]}for(;!y[0];)y.shift()}E[C++]=d?g:++g,y[0]&&d?y[w]=o[m]||0:y=[o[m]]}while((m++<b||y[0]!==l)&&c--);return E[0]||1==C||(E.shift(),x.e--),F<C&&r(x,f,n.RM,y[0]!==l),x},f.eq=function(t){return!this.cmp(t)},f.gt=function(t){return 0<this.cmp(t)},f.gte=function(t){return-1<this.cmp(t)},f.lt=function(t){return this.cmp(t)<0},f.lte=function(t){return this.cmp(t)<1},f.minus=f.sub=function(t){var r,e,n,i,o=this,s=o.constructor,u=o.s,c=(t=new s(t)).s;if(u!=c)return t.s=-c,o.plus(t);var a=o.c.slice(),f=o.e,l=t.c,h=t.e;if(!a[0]||!l[0])return l[0]?(t.s=-c,t):new s(a[0]?o:0);if(u=f-h){for((n=(i=u<0)?(u=-u,a):(h=f,l)).reverse(),c=u;c--;)n.push(0);n.reverse()}else for(e=((i=a.length<l.length)?a:l).length,u=c=0;c<e;c++)if(a[c]!=l[c]){i=a[c]<l[c];break}if(i&&(n=a,a=l,l=n,t.s=-t.s),0<(c=(e=l.length)-(r=a.length)))for(;c--;)a[r++]=0;for(c=r;u<e;){if(a[--e]<l[e]){for(r=e;r&&!a[--r];)a[r]=9;--a[r],a[e]+=10}a[e]-=l[e]}for(;0===a[--c];)a.pop();for(;0===a[0];)a.shift(),--h;return a[0]||(t.s=1,a=[h=0]),t.c=a,t.e=h,t},f.mod=function(t){var r,e=this,n=e.constructor,i=e.s,o=(t=new n(t)).s;if(!t.c[0])throw Error(a);return e.s=t.s=1,r=1==t.cmp(e),e.s=i,t.s=o,r?new n(e):(i=n.DP,o=n.RM,n.DP=n.RM=0,e=e.div(t),n.DP=i,n.RM=o,this.minus(e.times(t)))},f.plus=f.add=function(t){var r,e=this,n=e.constructor,i=e.s,o=(t=new n(t)).s;if(i!=o)return t.s=-o,e.minus(t);var s=e.e,u=e.c,c=t.e,a=t.c;if(!u[0]||!a[0])return a[0]?t:new n(u[0]?e:0*i);if(u=u.slice(),i=s-c){for((r=0<i?(c=s,a):(i=-i,u)).reverse();i--;)r.push(0);r.reverse()}for(u.length-a.length<0&&(r=a,a=u,u=r),i=a.length,o=0;i;u[i]%=10)o=(u[--i]=u[i]+a[i]+o)/10|0;for(o&&(u.unshift(o),++c),i=u.length;0===u[--i];)u.pop();return t.c=u,t.e=c,t},f.pow=function(t){var r=this,e=new r.constructor(1),n=e,i=t<0;if(t!==~~t||t<-1e6||1e6<t)throw Error(s+"exponent");for(i&&(t=-t);1&t&&(n=n.times(r)),t>>=1;)r=r.times(r);return i?e.div(n):n},f.round=function(t,e){var n=this.constructor;if(t===l)t=0;else if(t!==~~t||t<-i||i<t)throw Error(u);return r(new n(this),t,e===l?n.RM:e)},f.sqrt=function(){var t,e,n,i=this,s=i.constructor,u=i.s,c=i.e,a=new s(.5);if(!i.c[0])return new s(i);if(u<0)throw Error(o+"No square root");for(c=(t=0===(u=Math.sqrt(i+""))||u===1/0?((e=i.c.join("")).length+c&1||(e+="0"),c=((c+1)/2|0)-(c<0||1&c),new s(((u=Math.sqrt(e))==1/0?"1e":(u=u.toExponential()).slice(0,u.indexOf("e")+1))+c)):new s(u)).e+(s.DP+=4);n=t,t=a.times(n.plus(i.div(n))),n.c.slice(0,c).join("")!==t.c.slice(0,c).join(""););return r(t,s.DP-=4,s.RM)},f.times=f.mul=function(t){var r,e=this.constructor,n=this.c,i=(t=new e(t)).c,o=n.length,s=i.length,u=this.e,c=t.e;if(t.s=this.s==t.s?1:-1,!n[0]||!i[0])return new e(0*t.s);for(t.e=u+c,o<s&&(r=n,n=i,i=r,c=o,o=s,s=c),r=new Array(c=o+s);c--;)r[c]=0;for(u=s;u--;){for(s=0,c=o+u;u<c;)s=r[c]+i[u]*n[c-u-1]+s,r[c--]=s%10,s=s/10|0;r[c]=(r[c]+s)%10}for(s?++t.e:r.shift(),u=r.length;!r[--u];)r.pop();return t.c=r,t},f.toExponential=function(t){return e(this,1,t,t)},f.toFixed=function(t){return e(this,2,t,this.e+t)},f.toPrecision=function(t){return e(this,3,t,t-1)},f.toString=function(){return e(this)},f.valueOf=f.toJSON=function(){return e(this,4)},(n=function t(){function r(e){var n=this;if(!(n instanceof r))return e===l?t():new r(e);e instanceof r?(n.s=e.s,n.e=e.e,n.c=e.c.slice()):function(t,r){var e,n,i;if(0===r&&1/r<0)r="-0";else if(!h.test(r+=""))throw Error(s+"number");for(t.s="-"==r.charAt(0)?(r=r.slice(1),-1):1,-1<(e=r.indexOf("."))&&(r=r.replace(".","")),0<(n=r.search(/e/i))?(e<0&&(e=n),e+=+r.slice(n+1),r=r.substring(0,n)):e<0&&(e=r.length),i=r.length,n=0;n<i&&"0"==r.charAt(n);)++n;if(n==i)t.c=[t.e=0];else{for(;0<i&&"0"==r.charAt(--i););for(t.e=e-n-1,t.c=[],e=0;n<=i;)t.c[e++]=+r.charAt(n++)}}(n,e),n.constructor=r}return r.prototype=f,r.DP=20,r.RM=1,r.NE=-7,r.PE=21,r.version="5.2.2",r}()).default=n.Big=n,"function"==typeof define&&define.amd?define(function(){return n}):"undefined"!=typeof module&&module.exports?module.exports=n:t.Big=n}(this);var r={"":0,K:3,M:6,G:9,T:12,P:15,E:18},e=function(t){return t<1e3?"":t<1e6?"K":t<1e9?"M":t<1e12?"G":t<1e15?"T":t<1e18?"P":"E"};CalcNumber.NUMBER="n",CalcNumber.PERCENT="p",CalcNumber.SI_NUMBER="s",function(t){"use strict";function r(t,e,n,i){this.message=t,this.expected=e,this.found=n,this.location=i,this.name="SynErrA","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,r)}function e(t,e){function n(t,r){return{type:"literal",text:t,ignoreCase:r}}function i(t,r,e){return{type:"class",parts:t,inverted:r,ignoreCase:e}}function o(t){return{type:"other",description:t}}function s(r){var e,n=J[r];if(n)return n;for(e=r-1;!J[e];)e--;for(n={line:(n=J[e]).line,column:n.column};e<r;)10===t.charCodeAt(e)?(n.line++,n.column=1):n.column++,e++;return J[r]=n,n}function u(t,r){var e=s(t),n=s(r);return{start:{offset:t,line:e.line,column:e.column},end:{offset:r,line:n.line,column:n.column}}}function c(t){K<W||(K>W&&(W=K,$=[]),$.push(t))}function a(t,e,n){return new r(r.buildMessage(t,e),t,e,n)}function f(){var t,r,e;for(t=K,r=[],e=l();e!==m;)r.push(e),e=l();return r!==m&&(Y=t,r=w(r)),t=r}function l(){var r;return(r=function(){var r,e,n,i,o,s,u,a,f,l,g;if(r=K,(e=function(){var r;return 10===t.charCodeAt(K)?(r=x,K++):(r=m,0===Q&&c(E)),r===m&&(r=function(){var r,e;return Q++,r=K,Y=K,e=(e=X())?void 0:m,r=e!==m?t.substring(r,K):e,Q--,r===m&&(e=m,0===Q&&c(D)),r}()),r}())!==m){if(n=K,i=K,(o=h())!==m){if(s=[],u=K,10===t.charCodeAt(K)?(a=x,K++):(a=m,0===Q&&c(E)),a!==m){for(f=[],l=v();l!==m;)f.push(l),l=v();f!==m?(C.test(t.charAt(K))?(l=t.charAt(K),K++):(l=m,0===Q&&c(F)),l!==m&&(g=h())!==m?u=a=[a,f,l,g]:(K=u,u=m)):(K=u,u=m)}else K=u,u=m;if(u!==m)for(;u!==m;)if(s.push(u),u=K,10===t.charCodeAt(K)?(a=x,K++):(a=m,0===Q&&c(E)),a!==m){for(f=[],l=v();l!==m;)f.push(l),l=v();f!==m?(C.test(t.charAt(K))?(l=t.charAt(K),K++):(l=m,0===Q&&c(F)),l!==m&&(g=h())!==m?u=a=[a,f,l,g]:(K=u,u=m)):(K=u,u=m)}else K=u,u=m;else s=m;s!==m?i=o=[o,s]:(K=i,i=m)}else K=i,i=m;(n=i!==m?t.substring(n,K):i)!==m?(i=K,o=K,10===t.charCodeAt(K)?(s=x,K++):(s=m,0===Q&&c(E)),s!==m&&(u=function(){var r,e,n,i,o,s;Q++,r=K,e=K,n=[],i=v();for(;i!==m;)n.push(i),i=v();if(n!==m)if(61===t.charCodeAt(K)?(i=I,K++):(i=m,0===Q&&c(P)),i!==m){for(o=[],s=v();s!==m;)o.push(s),s=v();o!==m?e=n=[n,i,o]:(K=e,e=m)}else K=e,e=m;else K=e,e=m;r=e!==m?t.substring(r,K):e;Q--,r===m&&(e=m,0===Q&&c(L));return r}())!==m?((a=h())===m&&(a=null),a!==m?o=s=[s,u,a]:(K=o,o=m)):(K=o,o=m),(i=o!==m?t.substring(i,K):i)!==m&&(o=p())!==m?(Y=r,e=M(e,n,i,o),r=e):(K=r,r=m)):(K=r,r=m)}else K=r,r=m;return r}())===m&&(r=function(){var r,e,n,i,o,s;r=K,e=K,n=K,i=[],o=v();for(;o!==m;)i.push(o),o=v();i!==m?((o=g())===m&&(o=null),o!==m&&(s=function(){var r,e,n,i;Q++,r=K,e=K,13===t.charCodeAt(K)?(n=q,K++):(n=m,0===Q&&c(z));n===m&&(n=null);n!==m&&(i=function(){var r;Q++,10===t.charCodeAt(K)?(r=x,K++):(r=m,0===Q&&c(E));Q--,r===m&&(m,0===Q&&c(H));return r}())!==m?e=n=[n,i]:(K=e,e=m);r=e!==m?t.substring(r,K):e;Q--,r===m&&(e=m,0===Q&&c(H));return r}())!==m?n=i=[i,o,s]:(K=n,n=m)):(K=n,n=m);if(n===m){if(n=K,i=[],(o=v())!==m)for(;o!==m;)i.push(o),o=v();else i=m;if(i===m){for(i=K,o=[],s=v();s!==m;)o.push(s),s=v();o!==m&&(s=g())!==m?i=o=[o,s]:(K=i,i=m)}i!==m&&(o=d())!==m?n=i=[i,o]:(K=n,n=m)}e=n!==m?t.substring(e,K):n;e!==m&&(Y=r,e=S());return r=e}())===m&&(r=function(){var t,r,e;t=K,(r=h())!==m&&(e=p())!==m?(Y=t,r=R(r,e),t=r):(K=t,t=m);return t}()),r}function h(){var r,e,n;if(r=K,e=[],B.test(t.charAt(K))?(n=t.charAt(K),K++):(n=m,0===Q&&c(k)),n!==m)for(;n!==m;)e.push(n),B.test(t.charAt(K))?(n=t.charAt(K),K++):(n=m,0===Q&&c(k));else e=m;return r=e!==m?t.substring(r,K):e}function p(){var r,e,n,i,o;for(r=K,e=K,n=[],i=v();i!==m;)n.push(i),i=v();return n!==m?((i=g())===m&&(i=null),i!==m?(10===t.charCodeAt(K)?(o=x,K++):(o=m,0===Q&&c(E)),o===m&&(o=d()),o!==m?e=n=[n,i,o]:(K=e,e=m)):(K=e,e=m)):(K=e,e=m),r=e!==m?t.substring(r,K):e}function g(){var r,e,n,i,o;if(r=K,e=K,35===t.charCodeAt(K)?(n=U,K++):(n=m,0===Q&&c(N)),n!==m){for(i=[],B.test(t.charAt(K))?(o=t.charAt(K),K++):(o=m,0===Q&&c(k));o!==m;)i.push(o),B.test(t.charAt(K))?(o=t.charAt(K),K++):(o=m,0===Q&&c(k));i!==m?e=n=[n,i]:(K=e,e=m)}else K=e,e=m;return r=e!==m?t.substring(r,K):e}function d(){var r,e,n;return Q++,r=K,e=K,Q++,t.length>K?(n=t.charAt(K),K++):(n=m,0===Q&&c(T)),Q--,n===m?e=void 0:(K=e,e=m),e!==m&&(Y=r,e=j()),r=e,Q--,r===m&&(e=m,0===Q&&c(O)),r}function v(){var r;return Q++,_.test(t.charAt(K))?(r=t.charAt(K),K++):(r=m,0===Q&&c(G)),Q--,r===m&&(m,0===Q&&c(V)),r}e=void 0!==e?e:{};var A,m={},b={Main:f},y=f,w=function(t){return t.join("")},x="\n",E=n("\n",!1),C=/^[\-+*\/]/,F=i(["-","+","*","/"],!1,!1),M=function(t,r,n,i){return t+e.app.atBlock(e,{linesPre:t.length,lines:r.split("\n").length+1,linesSuf:i.length,value:r+n,lastLine:n})+i},R=function(t,r){return e.app.atBlock(e,{linesPre:0,lines:1,linesPre:0,value:t,lastLine:t})+r},S=function(){return e.app.atEmptyLine(),t.substring(Y,K)},B=/^[^\n]/,k=i(["\n"],!0,!1),L=(o("variable-name"),i([["a","z"]],!1,!0),o("numeric"),n("-",!1),i([["0","9"]],!1,!1),i([".",","],!1,!1),n("…",!1),n("%",!1),i(["k","m","g","t","p","e"],!1,!0),n("b",!0),n("yte",!0),n("it",!0),o("'='")),I="=",P=n("=",!1),U="#",N=n("#",!1),O=o("end-of-input"),T={type:"any"},j=function(){return""},D=o("start-of-input"),X=function(){return 0===u(Y,K).start.offset},q=(o("any-whitespace"),i(["\r","\n"],!1,!1),o("line-whitespace"),"\r"),z=n("\r",!1),V=o("space-or-tab"),_=/^[ \t]/,G=i([" ","\t"],!1,!1),H=o("new-line"),K=0,Y=0,J=[{line:1,column:1}],W=0,$=[],Q=0;if("startRule"in e){if(!(e.startRule in b))throw new Error("Can't start from \""+e.startRule+'".');y=b[e.startRule]}if((A=y())!==m&&K===t.length)return A;throw A!==m&&K<t.length&&c({type:"end"}),a($,W<t.length?t.charAt(W):null,W<t.length?u(W,W+1):u(W,W))}!function(t,r){function e(){this.constructor=t}e.prototype=r.prototype,t.prototype=new e}(r,Error),r.buildMessage=function(t,r){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+e(t)})}function i(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+e(t)})}function o(t){return s[t.type](t)}var s={literal:function(t){return'"'+n(t.text)+'"'},class:function(t){var r,e="";for(r=0;r<t.parts.length;r++)e+=t.parts[r]instanceof Array?i(t.parts[r][0])+"-"+i(t.parts[r][1]):i(t.parts[r]);return"["+(t.inverted?"^":"")+e+"]"},any:function(t){return"any character"},end:function(t){return"EOI"},other:function(t){return t.description}};return"Expected "+function(t){var r,e,n=new Array(t.length);for(r=0;r<t.length;r++)n[r]=o(t[r]);if(n.sort(),n.length>0){for(r=1,e=1;r<n.length;r++)n[r-1]!==n[r]&&(n[e]=n[r],e++);n.length=e}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+n(t)+'"':"EOI"}(r)+" found."},t.a={SynErrA:r,parse:e}}(this),function(r){"use strict";function e(t,r,n,i){this.message=t,this.expected=r,this.found=n,this.location=i,this.name="SynErrC","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function n(r,n){function i(t,r){throw r=void 0!==r?r:a(wt,yt),function(t,r){return new e(t,null,null,r)}(t,r)}function o(t,r){return{type:"literal",text:t,ignoreCase:r}}function s(t,r,e){return{type:"class",parts:t,inverted:r,ignoreCase:e}}function u(t){return{type:"other",description:t}}function c(t){var e,n=xt[t];if(n)return n;for(e=t-1;!xt[e];)e--;for(n={line:(n=xt[e]).line,column:n.column};e<t;)10===r.charCodeAt(e)?(n.line++,n.column=1):n.column++,e++;return xt[t]=n,n}function a(t,r){var e=c(t),n=c(r);return{start:{offset:t,line:e.line,column:e.column},end:{offset:r,line:n.line,column:n.column}}}function f(t){yt<Et||(yt>Et&&(Et=yt,Ct=[]),Ct.push(t))}function l(t,r,n){return new e(e.buildMessage(t,r),t,r,n)}function h(){var t,e;return t=yt,(e=p())!==y&&function(){var t,e,n;Ft++,t=yt,e=yt,Ft++,r.length>yt?(n=r.charAt(yt),yt++):(n=y,0===Ft&&f(ht));Ft--,n===y?e=void 0:(yt=e,e=y);e!==y&&(wt=t,e=pt());t=e,Ft--,t===y&&(e=y,0===Ft&&f(lt));return t}()!==y?(wt=t,t=e=E(e)):(yt=t,t=y),t}function p(){var t,e,n,i,o,s;if(t=yt,(e=g())!==y){for(n=[],i=yt,43===r.charCodeAt(yt)?(o=C,yt++):(o=y,0===Ft&&f(F)),o===y&&(45===r.charCodeAt(yt)?(o=M,yt++):(o=y,0===Ft&&f(R))),o!==y&&(s=g())!==y?i=o=[o,s]:(yt=i,i=y);i!==y;)n.push(i),i=yt,43===r.charCodeAt(yt)?(o=C,yt++):(o=y,0===Ft&&f(F)),o===y&&(45===r.charCodeAt(yt)?(o=M,yt++):(o=y,0===Ft&&f(R))),o!==y&&(s=g())!==y?i=o=[o,s]:(yt=i,i=y);n!==y?(wt=t,t=e=S(e,n)):(yt=t,t=y)}else yt=t,t=y;return t}function g(){var t,e,n,i,o,s;if(t=yt,(e=d())!==y){for(n=[],i=yt,42===r.charCodeAt(yt)?(o=B,yt++):(o=y,0===Ft&&f(k)),o===y&&(47===r.charCodeAt(yt)?(o=L,yt++):(o=y,0===Ft&&f(I)),o===y&&(r.substr(yt,2)===P?(o=P,yt+=2):(o=y,0===Ft&&f(U)))),o!==y&&(s=d())!==y?i=o=[o,s]:(yt=i,i=y);i!==y;)n.push(i),i=yt,42===r.charCodeAt(yt)?(o=B,yt++):(o=y,0===Ft&&f(k)),o===y&&(47===r.charCodeAt(yt)?(o=L,yt++):(o=y,0===Ft&&f(I)),o===y&&(r.substr(yt,2)===P?(o=P,yt+=2):(o=y,0===Ft&&f(U)))),o!==y&&(s=d())!==y?i=o=[o,s]:(yt=i,i=y);n!==y?(wt=t,t=e=S(e,n)):(yt=t,t=y)}else yt=t,t=y;return t}function d(){var t,e,n,i,o,s;if(t=yt,(e=v())!==y){for(n=[],i=yt,94===r.charCodeAt(yt)?(o=N,yt++):(o=y,0===Ft&&f(O)),o!==y&&(s=v())!==y?i=o=[o,s]:(yt=i,i=y);i!==y;)n.push(i),i=yt,94===r.charCodeAt(yt)?(o=N,yt++):(o=y,0===Ft&&f(O)),o!==y&&(s=v())!==y?i=o=[o,s]:(yt=i,i=y);n!==y?(wt=t,t=e=S(e,n)):(yt=t,t=y)}else yt=t,t=y;return t}function v(){var t,e,n,i,o;for(t=yt,e=[],n=A();n!==y;)e.push(n),n=A();if(e!==y)if((n=function(){var t,e,n,i,o,s;t=yt,40===r.charCodeAt(yt)?(e=j,yt++):(e=y,0===Ft&&f(D));if(e!==y){for(n=[],i=A();i!==y;)n.push(i),i=A();if(n!==y)if((i=p())!==y){for(o=[],s=A();s!==y;)o.push(s),s=A();o!==y?(41===r.charCodeAt(yt)?(s=X,yt++):(s=y,0===Ft&&f(q)),s!==y?(wt=t,e=z(i),t=e):(yt=t,t=y)):(yt=t,t=y)}else yt=t,t=y;else yt=t,t=y}else yt=t,t=y;t===y&&(t=function(){var t,e;t=yt,(e=function(){var t,e,n;if(Ft++,t=yt,e=[],G.test(r.charAt(yt))?(n=r.charAt(yt),yt++):(n=y,0===Ft&&f(H)),n!==y)for(;n!==y;)e.push(n),G.test(r.charAt(yt))?(n=r.charAt(yt),yt++):(n=y,0===Ft&&f(H));else e=y;return t=e!==y?r.substring(t,yt):e,Ft--,t===y&&(e=y,0===Ft&&f(_)),t}())!==y&&(wt=t,e=V());return t=e}())===y&&(t=function(){var t,e,n,i,o,s,u,c,a;Ft++,t=yt,e=yt,n=yt,45===r.charCodeAt(yt)?(i=M,yt++):(i=y,0===Ft&&f(R));i===y&&(i=null);if(i!==y){if(o=[],Y.test(r.charAt(yt))?(s=r.charAt(yt),yt++):(s=y,0===Ft&&f(J)),s!==y)for(;s!==y;)o.push(s),Y.test(r.charAt(yt))?(s=r.charAt(yt),yt++):(s=y,0===Ft&&f(J));else o=y;if(o!==y){if(s=yt,W.test(r.charAt(yt))?(u=r.charAt(yt),yt++):(u=y,0===Ft&&f($)),u===y&&(u=null),u!==y){if(c=[],Y.test(r.charAt(yt))?(a=r.charAt(yt),yt++):(a=y,0===Ft&&f(J)),a!==y)for(;a!==y;)c.push(a),Y.test(r.charAt(yt))?(a=r.charAt(yt),yt++):(a=y,0===Ft&&f(J));else c=y;c!==y?s=u=[u,c]:(yt=s,s=y)}else yt=s,s=y;s===y&&(s=null),s!==y?n=i=[i,o,s]:(yt=n,n=y)}else yt=n,n=y}else yt=n,n=y;e=n!==y?r.substring(e,yt):n;e!==y?(8230===r.charCodeAt(yt)?(n=Q,yt++):(n=y,0===Ft&&f(Z)),n===y&&(n=null),n!==y?(37===r.charCodeAt(yt)?(i=tt,yt++):(i=y,0===Ft&&f(rt)),i===y&&(i=yt,et.test(r.charAt(yt))?(o=r.charAt(yt),yt++):(o=y,0===Ft&&f(nt)),o===y&&(o=null),o!==y?(s=yt,u=yt,r.substr(yt,1).toLowerCase()===it?(c=r.charAt(yt),yt++):(c=y,0===Ft&&f(ot)),c!==y?(r.substr(yt,3).toLowerCase()===st?(a=r.substr(yt,3),yt+=3):(a=y,0===Ft&&f(ut)),a===y&&(r.substr(yt,2).toLowerCase()===ct?(a=r.substr(yt,2),yt+=2):(a=y,0===Ft&&f(at))),a===y&&(a=null),a!==y?u=c=[c,a]:(yt=u,u=y)):(yt=u,u=y),(s=u!==y?r.substring(s,yt):u)!==y?i=o=[o,s]:(yt=i,i=y)):(yt=i,i=y)),i===y&&(i=null),i!==y?(wt=t,e=ft(e,i),t=e):(yt=t,t=y)):(yt=t,t=y)):(yt=t,t=y);Ft--,t===y&&(e=y,0===Ft&&f(K));return t}());return t}())!==y){for(i=[],o=A();o!==y;)i.push(o),o=A();i!==y?(wt=t,t=e=T(n)):(yt=t,t=y)}else yt=t,t=y;else yt=t,t=y;return t}function A(){var t;return Ft++,(t=m())===y&&(dt.test(r.charAt(yt))?(t=r.charAt(yt),yt++):(t=y,0===Ft&&f(vt))),Ft--,t===y&&(y,0===Ft&&f(gt)),t}function m(){var t;return Ft++,mt.test(r.charAt(yt))?(t=r.charAt(yt),yt++):(t=y,0===Ft&&f(bt)),Ft--,t===y&&(y,0===Ft&&f(At)),t}n=void 0!==n?n:{};var b,y={},w={Main:h},x=h,E=function(t){return t},C="+",F=o("+",!1),M="-",R=o("-",!1),S=function(t,r){return Mt(r,t)},B="*",k=o("*",!1),L="/",I=o("/",!1),P="of",U=o("of",!1),N="^",O=o("^",!1),T=function(t){return t},j="(",D=o("(",!1),X=")",q=o(")",!1),z=function(t){return t},V=function(){var t=n.app.fetchVari(r.substring(wt,yt));return t||function(t,e){throw e=void 0!==e?e:a(wt,yt),l([u(t)],r.substring(wt,yt),e)}("defined variable"),t},_=u("variable-name"),G=/^[a-z]/i,H=s([["a","z"]],!1,!0),K=u("numeric"),Y=/^[0-9]/,J=s([["0","9"]],!1,!1),W=/^[.,]/,$=s([".",","],!1,!1),Q="…",Z=o("…",!1),tt="%",rt=o("%",!1),et=/^[kmgtpe]/i,nt=s(["k","m","g","t","p","e"],!1,!0),it="b",ot=o("b",!0),st="yte",ut=o("yte",!0),ct="it",at=o("it",!0),ft=function(r,e){var n,i,o;return e&&(2===e.length?(i=e[0],o=e[1]):n=e[0]),new CalcNumber(r,n||"",o||"",i||"")},lt=(u("'='"),o("=",!1),o("#",!1),s(["\n"],!0,!1),u("end-of-input")),ht={type:"any"},pt=function(){return""},gt=(u("start-of-input"),u("any-whitespace")),dt=/^[\r\n]/,vt=s(["\r","\n"],!1,!1),At=(u("line-whitespace"),o("\r",!1),u("space-or-tab")),mt=/^[ \t]/,bt=s([" ","\t"],!1,!1),yt=(u("new-line"),o("\n",!1),0),wt=0,xt=[{line:1,column:1}],Et=0,Ct=[],Ft=0;if("startRule"in n){if(!(n.startRule in w))throw new Error("Can't start from \""+n.startRule+'".');x=w[n.startRule]}var Mt=function(t,r){for(var e=0;e<t.length;++e){var n=r.opType()+" "+t[e][0]+" "+t[e][1].opType(),o=r[n];o||i("Operator ("+n+") not found on ("+r+")"),r=o.call(r,t[e][1])}return r};if((b=x())!==y&&yt===r.length)return b;throw b!==y&&yt<r.length&&f({type:"end"}),l(Ct,Et<r.length?r.charAt(Et):null,Et<r.length?a(Et,Et+1):a(Et,Et))}!function(t,r){function e(){this.constructor=t}e.prototype=r.prototype,t.prototype=new e}(e,Error),e.buildMessage=function(t,r){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+e(t)})}function i(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+e(t)})}function o(t){return s[t.type](t)}var s={literal:function(t){return'"'+n(t.text)+'"'},class:function(t){var r,e="";for(r=0;r<t.parts.length;r++)e+=t.parts[r]instanceof Array?i(t.parts[r][0])+"-"+i(t.parts[r][1]):i(t.parts[r]);return"["+(t.inverted?"^":"")+e+"]"},any:function(t){return"any character"},end:function(t){return"EOI"},other:function(t){return t.description}};return"Expected "+function(t){var r,e,n=new Array(t.length);for(r=0;r<t.length;r++)n[r]=o(t[r]);if(n.sort(),n.length>0){for(r=1,e=1;r<n.length;r++)n[r-1]!==n[r]&&(n[e]=n[r],e++);n.length=e}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+n(t)+'"':"EOI"}(r)+" found."},r.c={SynErrC:e,parse:n}}(this),function(r){"use strict";function e(t,r,n,i){this.message=t,this.expected=r,this.found=n,this.location=i,this.name="SynErrB","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function n(r,n){function i(){return r.substring(xt,wt)}function o(t,r){return{type:"literal",text:t,ignoreCase:r}}function s(t,r,e){return{type:"class",parts:t,inverted:r,ignoreCase:e}}function u(t){return{type:"other",description:t}}function c(t){var e,n=Et[t];if(n)return n;for(e=t-1;!Et[e];)e--;for(n={line:(n=Et[e]).line,column:n.column};e<t;)10===r.charCodeAt(e)?(n.line++,n.column=1):n.column++,e++;return Et[t]=n,n}function a(t,r){var e=c(t),n=c(r);return{start:{offset:t,line:e.line,column:e.column},end:{offset:r,line:n.line,column:n.column}}}function f(t){wt<Ct||(wt>Ct&&(Ct=wt,Ft=[]),Ft.push(t))}function l(t,r,n){return new e(e.buildMessage(t,r),t,r,n)}function h(){var t,e,n,i,o,s;for(t=wt,e=wt,n=[],i=w();i!==E;)n.push(i),i=w();if((e=n!==E?r.substring(e,wt):n)!==E)if((n=function(){var t,r,e,n,i;t=wt,r=[],e=wt,(n=v())!==E&&(i=m())!==E?e=n=[n,i]:(wt=e,e=E);if(e!==E)for(;e!==E;)r.push(e),e=wt,(n=v())!==E&&(i=m())!==E?e=n=[n,i]:(wt=e,e=E);else r=E;r!==E&&(e=A())!==E&&(n=d())!==E?(xt=t,r=S(r,e),t=r):(wt=t,t=E);return t}())===E&&(n=function(){var t,r,e;t=wt,(r=A())!==E&&w()!==E&&(e=v())!==E&&d()!==E?(xt=t,r=R(r,e),t=r):(wt=t,t=E);return t}())===E&&(n=function(){var t,e,n,i,o,s,u;t=wt,e=[],n=wt,(i=v())!==E&&(o=m())!==E?n=i=[i,o]:(wt=n,n=E);for(;n!==E;)e.push(n),n=wt,(i=v())!==E&&(o=m())!==E?n=i=[i,o]:(wt=n,n=E);if(e!==E)if((n=function(){var t,e,n,i,o,s,u,c;if(t=wt,e=wt,(n=g())!==E){if(i=wt,o=[],s=wt,10===r.charCodeAt(wt)?(u=P,wt++):(u=E,0===Mt&&f(U)),u!==E&&(c=g())!==E?s=u=[u,c]:(wt=s,s=E),s!==E)for(;s!==E;)o.push(s),s=wt,10===r.charCodeAt(wt)?(u=P,wt++):(u=E,0===Mt&&f(U)),u!==E&&(c=g())!==E?s=u=[u,c]:(wt=s,s=E);else o=E;o!==E?(10===r.charCodeAt(wt)?(s=P,wt++):(s=E,0===Mt&&f(U)),s!==E?i=o=[o,s]:(wt=i,i=E)):(wt=i,i=E),i===E&&(i=null),i!==E?e=n=[n,i]:(wt=e,e=E)}else wt=e,e=E;t=e!==E?r.substring(t,wt):e;return t}())!==E){for(i=[],o=wt,(s=m())!==E&&(u=p())!==E?o=s=[s,u]:(wt=o,o=E);o!==E;)i.push(o),o=wt,(s=m())!==E&&(u=p())!==E?o=s=[s,u]:(wt=o,o=E);if(i!==E){for(o=wt,s=[],u=w();u!==E;)s.push(u),u=w();(o=s!==E?r.substring(o,wt):s)!==E&&(s=y())!==E?(xt=t,e=B(e,n,i,o),t=e):(wt=t,t=E)}else wt=t,t=E}else wt=t,t=E;else wt=t,t=E;return t}()),n!==E){for(i=wt,o=[],s=w();s!==E;)o.push(s),s=w();(i=o!==E?r.substring(i,wt):o)!==E?(xt=t,t=e=M(e,n,i)):(wt=t,t=E)}else wt=t,t=E;else wt=t,t=E;return t}function p(){var t;return(t=function(){var t,e,n;if(t=wt,(e=function(){var t,e,n;if(t=wt,e=[],63===r.charCodeAt(wt)?(n=L,wt++):(n=E,0===Mt&&f(I)),n!==E)for(;n!==E;)e.push(n),63===r.charCodeAt(wt)?(n=L,wt++):(n=E,0===Mt&&f(I));else e=E;return e!==E&&(xt=t,e=k()),t=e}())===E&&(e=A())===E){if(e=[],(n=w())!==E)for(;n!==E;)e.push(n),n=w();else e=E;e===E&&(e=y())}e!==E&&(xt=t,e=k());return t=e}())===E&&(t=v()),t}function g(){var t,e,n,i;if(t=wt,e=wt,n=[],N.test(r.charAt(wt))?(i=r.charAt(wt),wt++):(i=E,0===Mt&&f(O)),i===E&&(T.test(r.charAt(wt))?(i=r.charAt(wt),wt++):(i=E,0===Mt&&f(j)),i===E&&(D.test(r.charAt(wt))?(i=r.charAt(wt),wt++):(i=E,0===Mt&&f(X)),i===E&&(i=w()))),i!==E)for(;i!==E;)n.push(i),N.test(r.charAt(wt))?(i=r.charAt(wt),wt++):(i=E,0===Mt&&f(O)),i===E&&(T.test(r.charAt(wt))?(i=r.charAt(wt),wt++):(i=E,0===Mt&&f(j)),i===E&&(D.test(r.charAt(wt))?(i=r.charAt(wt),wt++):(i=E,0===Mt&&f(X)),i===E&&(i=w())));else n=E;return(e=n!==E?r.substring(e,wt):e)!==E?((n=b())===E&&(n=null),n!==E?t=e=[e,n]:(wt=t,t=E)):(wt=t,t=E),t}function d(){var t,e,n,i,o;for(t=wt,e=wt,n=[],i=w();i!==E;)n.push(i),i=w();return n!==E?((i=b())===E&&(i=null),i!==E&&(o=y())!==E?e=n=[n,i,o]:(wt=e,e=E)):(wt=e,e=E),t=e!==E?r.substring(t,wt):e}function v(){var t,e,n;if(Mt++,t=wt,e=[],T.test(r.charAt(wt))?(n=r.charAt(wt),wt++):(n=E,0===Mt&&f(j)),n!==E)for(;n!==E;)e.push(n),T.test(r.charAt(wt))?(n=r.charAt(wt),wt++):(n=E,0===Mt&&f(j));else e=E;return t=e!==E?r.substring(t,wt):e,Mt--,t===E&&(e=E,0===Mt&&f(q)),t}function A(){var t,e,n,i,o,s,u,c,a;if(Mt++,t=wt,e=wt,n=wt,45===r.charCodeAt(wt)?(i=V,wt++):(i=E,0===Mt&&f(_)),i===E&&(i=null),i!==E){if(o=[],G.test(r.charAt(wt))?(s=r.charAt(wt),wt++):(s=E,0===Mt&&f(H)),s!==E)for(;s!==E;)o.push(s),G.test(r.charAt(wt))?(s=r.charAt(wt),wt++):(s=E,0===Mt&&f(H));else o=E;if(o!==E){if(s=wt,K.test(r.charAt(wt))?(u=r.charAt(wt),wt++):(u=E,0===Mt&&f(Y)),u===E&&(u=null),u!==E){if(c=[],G.test(r.charAt(wt))?(a=r.charAt(wt),wt++):(a=E,0===Mt&&f(H)),a!==E)for(;a!==E;)c.push(a),G.test(r.charAt(wt))?(a=r.charAt(wt),wt++):(a=E,0===Mt&&f(H));else c=E;c!==E?s=u=[u,c]:(wt=s,s=E)}else wt=s,s=E;s===E&&(s=null),s!==E?n=i=[i,o,s]:(wt=n,n=E)}else wt=n,n=E}else wt=n,n=E;return(e=n!==E?r.substring(e,wt):e)!==E?(8230===r.charCodeAt(wt)?(n=J,wt++):(n=E,0===Mt&&f(W)),n===E&&(n=null),n!==E?(37===r.charCodeAt(wt)?(i=$,wt++):(i=E,0===Mt&&f(Q)),i===E&&(i=wt,Z.test(r.charAt(wt))?(o=r.charAt(wt),wt++):(o=E,0===Mt&&f(tt)),o===E&&(o=null),o!==E?(s=wt,u=wt,r.substr(wt,1).toLowerCase()===rt?(c=r.charAt(wt),wt++):(c=E,0===Mt&&f(et)),c!==E?(r.substr(wt,3).toLowerCase()===nt?(a=r.substr(wt,3),wt+=3):(a=E,0===Mt&&f(it)),a===E&&(r.substr(wt,2).toLowerCase()===ot?(a=r.substr(wt,2),wt+=2):(a=E,0===Mt&&f(st))),a===E&&(a=null),a!==E?u=c=[c,a]:(wt=u,u=E)):(wt=u,u=E),(s=u!==E?r.substring(s,wt):u)!==E?i=o=[o,s]:(wt=i,i=E)):(wt=i,i=E)),i===E&&(i=null),i!==E?(xt=t,t=e=ut(e,i)):(wt=t,t=E)):(wt=t,t=E)):(wt=t,t=E),Mt--,t===E&&(e=E,0===Mt&&f(z)),t}function m(){var t,e,n,i,o,s;for(Mt++,t=wt,e=wt,n=[],i=w();i!==E;)n.push(i),i=w();if(n!==E)if(61===r.charCodeAt(wt)?(i=at,wt++):(i=E,0===Mt&&f(ft)),i!==E){for(o=[],s=w();s!==E;)o.push(s),s=w();o!==E?e=n=[n,i,o]:(wt=e,e=E)}else wt=e,e=E;else wt=e,e=E;return t=e!==E?r.substring(t,wt):e,Mt--,t===E&&(e=E,0===Mt&&f(ct)),t}function b(){var t,e,n,i,o;if(t=wt,e=wt,35===r.charCodeAt(wt)?(n=lt,wt++):(n=E,0===Mt&&f(ht)),n!==E){for(i=[],pt.test(r.charAt(wt))?(o=r.charAt(wt),wt++):(o=E,0===Mt&&f(gt));o!==E;)i.push(o),pt.test(r.charAt(wt))?(o=r.charAt(wt),wt++):(o=E,0===Mt&&f(gt));i!==E?e=n=[n,i]:(wt=e,e=E)}else wt=e,e=E;return t=e!==E?r.substring(t,wt):e}function y(){var t,e,n;return Mt++,t=wt,e=wt,Mt++,r.length>wt?(n=r.charAt(wt),wt++):(n=E,0===Mt&&f(vt)),Mt--,n===E?e=void 0:(wt=e,e=E),e!==E&&(xt=t,e=At()),t=e,Mt--,t===E&&(e=E,0===Mt&&f(dt)),t}function w(){var t;return Mt++,bt.test(r.charAt(wt))?(t=r.charAt(wt),wt++):(t=E,0===Mt&&f(yt)),Mt--,t===E&&(E,0===Mt&&f(mt)),t}n=void 0!==n?n:{};var x,E={},C={Main:h},F=h,M=function(t,r,e){return t+r+e},R=function(t,r){return n.app.atDefinition(),n.app.setVari(r,t),i()},S=function(t,r){n.app.atDefinition();for(var e of t)n.app.setVari(e[0],r);return i()},B=function(t,r,e,i){var o=n.app.atProblem(n,{value:r,headRaw:t,tailRaw:e}),s="";return s+=Rt(t,!0,o),s+=r,s+=Rt(e,!1,o),s+=i},k=function(){return null},L="?",I=o("?",!1),P="\n",U=o("\n",!1),N=/^[0-9.,%]/,O=s([["0","9"],".",",","%"],!1,!1),T=/^[a-z]/i,j=s([["a","z"]],!1,!0),D=/^[\-+*\/^()]/,X=s(["-","+","*","/","^","(",")"],!1,!1),q=u("variable-name"),z=u("numeric"),V="-",_=o("-",!1),G=/^[0-9]/,H=s([["0","9"]],!1,!1),K=/^[.,]/,Y=s([".",","],!1,!1),J="…",W=o("…",!1),$="%",Q=o("%",!1),Z=/^[kmgtpe]/i,tt=s(["k","m","g","t","p","e"],!1,!0),rt="b",et=o("b",!0),nt="yte",it=o("yte",!0),ot="it",st=o("it",!0),ut=function(r,e){var n,i,o;return e&&(2===e.length?(i=e[0],o=e[1]):n=e[0]),new CalcNumber(String(r),n||"",o||"",i||"")},ct=u("'='"),at="=",ft=o("=",!1),lt="#",ht=o("#",!1),pt=/^[^\n]/,gt=s(["\n"],!0,!1),dt=u("end-of-input"),vt={type:"any"},At=function(){return""},mt=(u("start-of-input"),u("any-whitespace"),s(["\r","\n"],!1,!1),u("line-whitespace"),o("\r",!1),u("space-or-tab")),bt=/^[ \t]/,yt=s([" ","\t"],!1,!1),wt=(u("new-line"),0),xt=0,Et=[{line:1,column:1}],Ct=0,Ft=[],Mt=0;if("startRule"in n){if(!(n.startRule in C))throw new Error("Can't start from \""+n.startRule+'".');F=C[n.startRule]}const Rt=function(t,r,e){var i,o,s="";r?(o=0,i=1):(i=0,o=1);for(var u of t){if(!1===r&&(s+=u[i]),null===u[o])s+=n.app.format(e);else{if("string"!=typeof u[o])throw new Error("Unknown type: "+typeof u[o]);n.app.setVari(u[o],e),s+=u[o]}!0===r&&(s+=u[i])}return s};if((x=F())!==E&&wt===r.length)return x;throw x!==E&&wt<r.length&&f({type:"end"}),l(Ft,Ct<r.length?r.charAt(Ct):null,Ct<r.length?a(Ct,Ct+1):a(Ct,Ct))}!function(t,r){function e(){this.constructor=t}e.prototype=r.prototype,t.prototype=new e}(e,Error),e.buildMessage=function(t,r){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+e(t)})}function i(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+e(t)})}function o(t){return s[t.type](t)}var s={literal:function(t){return'"'+n(t.text)+'"'},class:function(t){var r,e="";for(r=0;r<t.parts.length;r++)e+=t.parts[r]instanceof Array?i(t.parts[r][0])+"-"+i(t.parts[r][1]):i(t.parts[r]);return"["+(t.inverted?"^":"")+e+"]"},any:function(t){return"any character"},end:function(t){return"EOI"},other:function(t){return t.description}};return"Expected "+function(t){var r,e,n=new Array(t.length);for(r=0;r<t.length;r++)n[r]=o(t[r]);if(n.sort(),n.length>0){for(r=1,e=1;r<n.length;r++)n[r-1]!==n[r]&&(n[e]=n[r],e++);n.length=e}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+n(t)+'"':"EOI"}(r)+" found."},r.b={SynErrB:e,parse:n}}(this);</script>
    <script>
    window.calculatorApp = new function(){
        var t = this,
            r = document.getElementById("editor"),
            e = document.getElementById("backdrop"),
            n = document.getElementById("canvas"),
            f = document.getElementById("copyBtn"),
            l = r.cols,
            h = r.rows,
            p = [],
            g = 0,
            d = {},
            lineEvents = [],
            lastProblemResult = null,
            currentBlockLine = 0;
        
        this.merge=function(t,r){return r=r||{},Object.assign({},t,r||{})};
        
        this.atProblem=function(r,e){
            e=this.merge(r,e);
            const value = e.value.trim().toLowerCase();
            const magicKeywords = ['total', 'totalvars', 'subtotal', 'subtotalvars'];

            if (magicKeywords.includes(value)) {
                let total = new Big(0);

                if (value === 'totalvars') {
                    // Sum the current values of ALL defined variables
                    for (const varName in d) {
                        if (d.hasOwnProperty(varName) && d[varName] && d[varName].big) {
                            total = total.plus(d[varName].big);
                        }
                    }
                } else {
                    // Find the starting point for the calculation
                    let lastMarkerIndex = -1;
                    if (value === 'subtotal' || value === 'subtotalvars') {
                        for (let i = lineEvents.length - 1; i >= 0; i--) {
                            // FIX: A keyword should only be reset by a previous instance of the SAME keyword.
                            if (lineEvents[i].type === 'keyword' && lineEvents[i].name === value) {
                                lastMarkerIndex = i;
                                break;
                            }
                        }
                    }
                    const relevantEvents = lineEvents.slice(lastMarkerIndex + 1);

                    if (value === 'subtotalvars') {
                        const definitions = relevantEvents.filter(event => event.type === 'definition');
                        const latestVarValues = {};
                        definitions.forEach(event => {
                            latestVarValues[event.name] = event.value;
                        });
                        for (const varName in latestVarValues) {
                            if (latestVarValues[varName] && latestVarValues[varName].big) {
                                total = total.plus(latestVarValues[varName].big);
                            }
                        }
                    } else { // 'total' or 'subtotal'
                        const eventsToSum = relevantEvents.filter(event => event.type === 'problem' || event.type === 'definition');
                        eventsToSum.forEach(event => {
                            const result = event.result || event.value;
                            if (result && result.big) {
                                total = total.plus(result.big);
                            }
                        });
                    }
                }
                
                // FIX: Add a keyword marker for subtotal events ONLY if it's on a line by itself
                if ((value === 'subtotal' || value === 'subtotalvars') && e.headRaw.length === 0 && e.tailRaw.length === 0) {
                    lineEvents.push({ type: 'keyword', name: value, line: e.linesPre });
                }

                // --- Display the result ---
                var resultNum = new CalcNumber(total.toString(), false, '', '');
                var i = t.format(resultNum);
                t.pushFillers(e.linesPre + e.lines - 1, "calc-pre");
                var o = " ".repeat(e.lastLine.length) + " = " + i;
                this.setMaxX(o.length);
                this.pushLine("success", o);
                
                return resultNum;

            } else {
                // --- Original logic for normal calculations ---
                var n;
                try{
                    n=c.parse(e.value,e);
                    var i=t.format(n);
                    if(t.pushFillers(e.linesPre+e.lines-1,"calc-pre"),e.tailRaw.length)this.atEmptyLine("success");
                    else{
                        var o=" ".repeat(e.lastLine.length)+" = "+i;
                        this.setMaxX(o.length),
                        this.pushLine("success",o)
                    }

                    if (n && n.big) {
                        lastProblemResult = n; 
                        lineEvents.push({ type: 'problem', result: n, line: e.linesPre });
                    }
                }
                catch(r){
                    var s=0;
                    for(var u of e.headRaw)for(var a of u)s+=a.length;
                    if(!r.location)throw r;
                    r.location.start.offset+=s,r.location.start.column+=s,r.location.end.offset+=s,r.location.end.column+=s,t.pushFailFilled(e,r,"calc parser")
                }
                return n
            }
        };
        this.atBlock=function(r,e){
            e=this.merge(r,e);
            currentBlockLine = e.linesPre;
            try{return b.parse(e.value,e)}catch(r){if(r.location)return t.pushFailFilled(e,r,"block parser"),e.value;throw r}
        };
        this.atDefinition=function(){t.pushLine("definition","")};
        this.atEmptyLine=function(r){t.pushFiller(r)};
        this.setVari=function(name, val){
            d[name.toLowerCase()]=val;
            if (val !== lastProblemResult) {
                if (val && val.big) {
                    lineEvents.push({ type: 'definition', name: name.toLowerCase(), value: val, line: currentBlockLine });
                }
            }
            lastProblemResult = null;
        };
        this.fetchVari=function(t){var r=d[t.toLowerCase()];if(r)return r.clone()};
        this.format=function(t){return void 0===t?"???":null===t?"??":isNaN(t)?"?":"object"==typeof t?t.format():t.toString()};
        this.pushFailFilled=function(r,e,n){t.pushFillers(r.linesPre+e.location.start.line-1),t.pushFail(n,e.location.start.column-1),t.pushFillers(r.linesPre+r.lines+r.linesSuf-(e.location.start.line+1))};
        this.pushFillers=function(r,e){for(var n=0;n<r;++n)t.pushFiller(e)};
        this.pushFiller=function(r){r=r||"",t.pushLine("filler "+r," ")};
        this.pushFail=function(r,e){t.pushLine("fail "+r," ".repeat(e)+'<span class="marker"> </span>')};
        this.pushLine=function(t,r){e.innerHTML+='<div class="'+(t?Util.esc(t):"")+'">'+r+"</div>"};
        this.trigger=function(){e.innerText="",g=0,d={},lineEvents = [], lastProblemResult = null, currentBlockLine = 0;var n=r.selectionEnd,i=r.value,o="";p=i.split("\n");var s=this.setMaxXByLines(p);this.setEditorX(s),this.setEditorY(p.length);try{(o=a.parse(i,{app:t}))&&(r.value=o)}catch(r){if(!r.location)throw t.pushFail("root unknown",0),r;t.pushFail("root parser",r.location.start.column-1)}this.setMaxXByLines(o.split("\n")),this.setEditorX(g),this.setCaret(n),this.setSharing(r.value)};
        this.setSharing=function(t){
             // This is now handled by the wrapper's localStorage logic.
             // We keep the function to avoid breaking the core calculator logic.
        };
        this.setCaret=function(t){r.selectionEnd=t};
        this.setMaxXByLines=function(t){var r=t.reduce(function(t,r){return t<r.length?r.length:t},0);return this.setMaxX(r),r};
        this.setMaxX=function(t){g=Math.max(t,g)};
        this.setEditorX=function(t){r.cols=Math.max(t,l)};
        this.setEditorY=function(t){r.rows=Math.max(t,h)};
        
        r.addEventListener("input",function(){t.trigger()});
        n.addEventListener("click",function(){r.focus()});
        
        r.focus();
        
        f.addEventListener("click",function(e){
            e.preventDefault();
            r.select();
            try {
                document.execCommand("copy");
            } catch (err) {
                console.error("Could not copy text: ", err);
            }
        });
        
        // Auto-resize textarea height
        const autoResize = () => {
            r.style.height = 'auto';
            r.style.height = r.scrollHeight + 'px';
            e.style.height = r.style.height;
        };
        r.addEventListener('input', autoResize);
        window.addEventListener('resize', autoResize);

        // Trigger initial calculation and resize
        t.trigger();
        autoResize();
    };
    </script>
</body>
</html>